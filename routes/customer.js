// Generated by CoffeeScript 1.10.0
(function() {
  var customer, routes, thereIsEmail, validateEmail;

  customer = require('../models/customer');

  validateEmail = function(email) {
    var re;
    re = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
    return re.test(email);
  };

  thereIsEmail = function(email, cb) {
    var criteria;
    criteria = {
      email: email
    };
    return customer.findOne(criteria, function(err, _customer_email) {
      if (err) {
        cb(err);
      } else {
        if (_customer_email === null) {
          cb(null, false);
        } else if (_customer_email !== null) {
          cb(null, true);
        }
      }
    });
  };

  routes = function(app) {
    app.post('/customer', function(req, res) {
      var attributes, isValid;
      attributes = {
        name: req.body.name,
        email: req.body.email,
        preferred_barber: req.body.preferred_barber
      };
      isValid = validateEmail(req.body.email);
      if (req.body.name !== "" && req.body.email !== "" && req.body.preferredBarber !== "") {
        if (isValid) {
          return thereIsEmail(req.body.email, function(err, flag) {
            var new_customer;
            if (flag === false) {
              new_customer = new customer(attributes);
              return new_customer.save(function(err, customer) {
                if (err) {
                  return res.json(err, 500);
                }
                return res.json(customer);
              });
            } else {
              return res.status(400).send('Email already exists');
            }
          });
        } else {
          return res.status(400).send('Email not valid.');
        }
      } else {
        return res.status(400).send('The name, email and preferred_barber is required');
      }
    });
    app.get('/customer/:id', function(req, res) {
      var criteria;
      criteria = {
        _id: req.params.id
      };
      return customer.findOne(criteria, function(err, _customer) {
        if (err) {
          return res.json(err, 400);
        } else {
          if (_customer === null || _customer === void 0) {
            return res.status(404).send('customer not found');
          } else {
            return res.json(_customer);
          }
        }
      });
    });
    return app.put('/customer/:id', function(req, res) {
      var criteria;
      criteria = {
        _id: req.params.id
      };
      return customer.findOne(criteria, function(err, _customer) {
        var email_custumer;
        if (err) {
          return res.json(err, 400);
        } else {
          if (_customer === null || _customer === void 0) {
            return res.status(404).send('customer not found');
          } else {
            email_custumer = _customer.email;
            if (req.body.name && req.body.name !== "") {
              _customer.name = req.body.name;
            }
            if (req.body.preferred_barber && req.body.preferred_barber !== "") {
              _customer.preferred_barber = req.body.preferred_barber;
            }
            if (req.body.email && req.body.email !== "") {
              return thereIsEmail(req.body.email, function(err, flag) {
                if (flag === false) {
                  _customer.email = req.body.email;
                  return _customer.save(function(err, update_customer) {
                    if (err) {
                      res.json(err, 500);
                    }
                    return res.json(update_customer);
                  });
                } else {
                  return res.status(404).send('Email already exists');
                }
              });
            } else {
              return _customer.save(function(err, update_customer) {
                if (err) {
                  rres.json(err, 500);
                }
                return res.json(update_customer);
              });
            }
          }
        }
      });
    });
  };

  module.exports = routes;

}).call(this);
